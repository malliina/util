Online guides (Ubuntu Server Guide, etc) suck, so here it is:

Disable apparmor and reboot

Create pass:
slappasswd -h {SSHA}

Create test.ldif:

dn: olcDatabase=hdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcHdbConfig
olcDatabase: hdb
olcDbDirectory: /opt/ldap/test
olcSuffix: dc=mle,dc=com
olcAccess: {0}to attrs=userPassword,shadowLastChange by self write by anonymous auth by dn="cn=admin,dc=mle,dc=com" write by * none
olcAccess: {1}to dn.base="" by * read
olcAccess: {2}to * by self write by dn="cn=admin,dc=mle,dc=com" write by * read
olcLastMod: TRUE
olcRootDN: cn=admin,dc=mle,dc=com
olcRootPW: {SSHA}J6jkTA6U5xndQfAE15I2GXeHC0yHJKQ1
olcDbCheckpoint: 512 30
olcDbConfig: {0}set_cachesize 0 2097152 0
olcDbConfig: {1}set_lk_max_objects 1500
olcDbConfig: {2}set_lk_max_locks 1500
olcDbConfig: {3}set_lk_max_lockers 1500
olcDbIndex: objectClass eq

Add test.ldif with:
ldapadd -Y EXTERNAL -H ldapi:/// -f test.ldif

Create add_content.ldif:

dn: dc=mle,dc=com
objectClass: top
objectClass: dcObject
objectclass: organization
o: Example Organization
dc: mle
description: LDAP Example

dn: cn=admin,dc=mle,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
userPassword: admin

dn: ou=People,dc=mle,dc=com
objectClass: organizationalUnit
ou: People

dn: ou=Groups,dc=mle,dc=com
objectClass: organizationalUnit
ou: Groups

dn: ou=Hosts,dc=mle,dc=com
objectClass: organizationalUnit
ou: Hosts

dn: cn=admins,ou=Groups,dc=mle,dc=com
objectClass: posixGroup
cn: admins
gidNumber: 5000

dn: uid=john,ou=People,dc=mle,dc=com
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: john
sn: Doe
givenName: John
cn: John Doe
displayName: John Doe
uidNumber: 10000
gidNumber: 5000
userPassword: john
gecos: John Doe
loginShell: /bin/bash
homeDirectory: /home/john

(endof add_content.ldif)

Password policy:

dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulePath: /usr/lib64/openldap/
olcModuleLoad: ppolicy.la

dn: ou=pwpolicies,dc=mle,dc=com
objectClass: organizationalUnit
objectClass: top
ou: policies

dn: cn=default,ou=pwpolicies,dc=mle,dc=com
cn: default
objectClass: pwdPolicyChecker
objectClass: pwdPolicy
objectClass: person
objectClass: top
pwdAllowUserChange: TRUE
pwdAttribute: 2.5.4.35
pwdCheckModule: crackcheck.so
pwdCheckQuality: 2
pwdExpireWarning: 604800
pwdFailureCountInterval: 30
pwdGraceAuthNLimit: 0
pwdInHistory: 10
pwdLockout: TRUE
pwdLockoutDuration: 3600
pwdMaxAge: 7776000
pwdMaxFailure: 5
pwdMinAge: 3600
pwdMinLength: 12
pwdMustChange: FALSE
pwdSafeModify: FALSE
sn: dummy value

dn: olcOverlay=ppolicy,olcDatabase={1}bdb,cn=config
olcOverlay: ppolicy
objectClass: olcOverlayConfig
objectClass: olcPPolicyConfig
olcPPolicyDefault: cn=default,ou=pwpolicies,dc=mle,dc=com
olcPPolicyHashCleartext: TRUE
olcPPolicyUseLockout: FALSE


Add add_content.ldif with:
ldapadd -x -D cn=admin,dc=mle,dc=com -W -f add_content.ldif

maxUid.ldif:

dn: cn=maxUid,dc=mle,dc=com
objectClass: extensibleObject
objectClass: top
uidNumber: 10000

maxGid.ldif:

dn: cn=maxGid,dc=mle,dc=com
objectClass: extensibleObject
objectClass: top
uidNumber: 5000

when adding a user:

dn: cn=maxUid,dc=mle,dc=com
changetype: modify
delete: uidNumber
uidNumber: 500
-
add: uidNumber
uidNumber: 501

Password policy:

Examples:

http://www.zytrax.com/books/ldap/ch5/index.html

testuser.ldif contents:

dn: uid=test,ou=People,dc=mle,dc=com
objectClass: inetOrgPerson
uid: test
userPassword: test
sn: Doe
cn: Test Doe

Add user 'test' (or any ldif):
ldapadd -Y EXTERNAL -H ldapi:/// -f testuser.ldif
ldapadd -x -D cn=admin,dc=mle,dc=com -W -f testuser.ldif

Remove user 'test':
ldapdelete -x -W -D 'cn=admin,dc=mle,dc=com' "uid=test,ou=People,dc=mle,dc=com"

List config:
ldapsearch -Y EXTERNAL -H ldapi:/// -b cn=config

List users:
ldapsearch -Y EXTERNAL -H ldapi:/// -b ou=People,dc=mle,dc=com

List user 'x':
ldapsearch -D "cn=admin,dc=mle,dc=com" -W -p 389 -h cent -s base -b "uid=ddd,ou=People,dc=mle,dc=com" "objectclass=*"
ldapsearch -D "cn=admin,dc=mle,dc=com" -W -p 389 -h cent -s base -b "cn=ubuntu,ou=Hosts,dc=mle,dc=com" "objectclass=*"


LDAP authentication on unix:

http://www.server-world.info/en/note?os=CentOS_6&p=ldap&f=2

cp system-auth password-auth

LDAP PAM auth in unix over TLS:
user nslcd must be able to read client-key.pem either through ownership or primary group membership. supplementary groups make no difference.

LDAP host-specific authorization:
on ubuntu, set "shadow compat" in /etc/nsswitch.conf, not "shadow compat ldap"
on centos, no change in nsswitch.conf seems necessary


Samba as primary domain controller for windows clients:

Follow http://www.server-world.info/en/note?os=CentOS_6&p=samba&f=4 but change 'w' to 'W' in smb.conf as in:
        #add machine script = /usr/sbin/smbldap-useradd -t 0 -w "%u"
        add machine script = /usr/sbin/smbldap-useradd -t 0 -W "%u"


perl /usr/share/doc/smbldap-tools-*/configure.pl
...
-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
backup old configuration files:
  /etc/smbldap-tools/smbldap.conf->/etc/smbldap-tools/smbldap.conf.old
  /etc/smbldap-tools/smbldap_bind.conf->/etc/smbldap-tools/smbldap_bind.conf.old
writing new configuration file:
  /etc/smbldap-tools/smbldap.conf done.
  /etc/smbldap-tools/smbldap_bind.conf done.
[root@cent1 tmp]#

[root@cent1 tmp]# smbldap-populate
Populating LDAP directory for domain MLEGROUP (S-1-5-21-184410074-1697016161-3073087301)
(using builtin directory structure)

entry dc=mle,dc=com already exist.
entry ou=People,dc=mle,dc=com already exist.
entry ou=Groups,dc=mle,dc=com already exist.
entry ou=Hosts,dc=mle,dc=com already exist.
adding new entry: ou=Idmap,dc=mle,dc=com
adding new entry: uid=root,ou=People,dc=mle,dc=com
adding new entry: uid=nobody,ou=People,dc=mle,dc=com
adding new entry: cn=Domain Admins,ou=Groups,dc=mle,dc=com
adding new entry: cn=Domain Users,ou=Groups,dc=mle,dc=com
adding new entry: cn=Domain Guests,ou=Groups,dc=mle,dc=com
adding new entry: cn=Domain Computers,ou=Groups,dc=mle,dc=com
adding new entry: cn=Administrators,ou=Groups,dc=mle,dc=com
adding new entry: cn=Account Operators,ou=Groups,dc=mle,dc=com
adding new entry: cn=Print Operators,ou=Groups,dc=mle,dc=com
adding new entry: cn=Backup Operators,ou=Groups,dc=mle,dc=com
adding new entry: cn=Replicators,ou=Groups,dc=mle,dc=com
entry sambaDomainName=MLEGROUP,dc=mle,dc=com already exist. Updating it...

Please provide a password for the domain root:
Changing UNIX and samba passwords for root
New password:
Retype new password:
[root@cent1 tmp]#